name: Deploy
on: workflow_call
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH client
        run: sudo apt-get update && sudo apt-get install -y openssh-client rsync

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | sed 's/\r$//' | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H arturscibor.pl >> ~/.ssh/known_hosts

      - name: Debug SSH Key...
        run: |
          ls -lah ~/.ssh
          wc -c ~/.ssh/id_rsa
          cat ~/.ssh/id_rsa | head -n 5

      - name: Pull latest changes from Git
        run: |
          ssh artur@arturscibor.pl '
            cd /var/www/pracaArturScibor/praca.strona.arturscibor.pl &&
            git reset --hard origin/main &&
            git clean -fd &&
            git pull origin main
          '
      - name: Set execute permissions for deploy.sh
        run: |
          ssh artur@arturscibor.pl 'chmod +x /var/www/pracaArturScibor/praca.strona.arturscibor.pl/deploy.sh'

      - name: Run deploy script on server
        run: |
          ssh artur@arturscibor.pl 'cd /var/www/pracaArturScibor/praca.strona.arturscibor.pl && sudo ./deploy.sh $(date +%Y%m%d%H%M)'
